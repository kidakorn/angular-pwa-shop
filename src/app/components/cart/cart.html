<div class="container">
	<div class="cart-page">
		<div class="header-section">
			<h2>ตะกร้าสินค้าของคุณ</h2>
			<a routerLink="/" class="back-link">กลับไปเลือกสินค้า</a>
		</div>

		@if (cartService.cartCount() > 0) {
		<div class="cart-container">
			<div class="cart-items">
				@for (item of cartService.getCartItems()(); track $index) {
				<div class="cart-item">
					<img [src]="item.product.imageUrl" [alt]="item.product.name">
					<div class="item-details">
						<h3>{{ item.product.name }}</h3>
						<p class="category">{{ item.product.category }}</p>

					</div>
					<div class="item-price">

						<div class="quantity-controls">
							<button class="qty-btn" (click)="cartService.updateQuantity($index, -1)">
								<lucide-icon name="minus" [size]="16"></lucide-icon>
							</button>

							<span class="qty-number">{{ item.quantity }}</span>

							<button class="qty-btn" (click)="cartService.updateQuantity($index, 1)">
								<lucide-icon name="plus" [size]="16"></lucide-icon>
							</button>
						</div>

						<div class="quantity-display">
							<span>{{ item.product.price | number }} x {{ item.quantity }}</span>
						</div>
						<span class="subtotal">{{ item.product.price * item.quantity | number }} บาท</span>
					</div>
					<button class="remove-btn" (click)="removeItem($index)">
						<lucide-icon name="trash-2" [size]="20"></lucide-icon>
					</button>
				</div>
				}
			</div>

			<div class="cart-summary">
				<h3>สรุปคำสั่งซื้อ</h3>
				<div class="summary-row">
					<span>จำนวนสินค้า</span>
					<span>{{ cartService.cartCount() }} ชิ้น</span>
				</div>
				<div class="summary-row total">
					<span>ราคารวมทั้งหมด</span>
					<span>{{ cartService.totalPrice() | number }} บาท</span>
				</div>
				<button class="checkout-btn" (click)="openCheckout()">ชำระเงิน</button>
			</div>
		</div>

		} @else {

		<div class="empty-cart">
			<lucide-icon name="shopping-bag" [size]="64"></lucide-icon>
			<p>ยังไม่มีสินค้าในตะกร้าของคุณ</p>
			<button routerLink="/" class="shop-now-btn">ไปช้อปปิ้งกันเลย</button>
		</div>
		}
	</div>
</div>

@if (isCheckoutOpen()) {
<div class="modal-overlay" (click)="closeCheckout()">
	<div class="modal-content" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<h3>ข้อมูลจัดส่งสินค้า</h3>
			<button class="close-model" (click)="closeCheckout()">
				<lucide-icon name="x" [size]="20"></lucide-icon>
			</button>
		</div>

		<form class="checkout-form" [formGroup]="checkoutForm">
			<div class="form-group">
				<label>ชื่อ-นามสกุล</label>
				<input type="text" placeholder="กรอกชื่อผู้รับ" formControlName="name">
			</div>

			<div class="form-group">
				<label>เบอร์โทรศัพท์</label>
				<input type="tel" placeholder="08x-xxxxxxx" maxlength="10" formControlName="phone"
					(input)="validateNumber($event)">
			</div>

			<div class="form-group">
				<label>ที่อยู่ (บ้านเลขที่/ซอย/ถนน)</label>
				<textarea placeholder="กรอกรายละเอียดที่อยู่" formControlName="addressDetail" rows="3"></textarea>
			</div>

			<div class="form-group">
				<label>รหัสไปรษณีย์</label>
				<input type="text" placeholder="xxxxx" maxlength="5" formControlName="postalCode"
					(input)="validateNumber($event)">
			</div>

			<div class="form-row">
				<div class="form-group">
					<label>แขวง/ตำบล</label>
					<select formControlName="subDistrict">
						<option value="">เลือกตำบล</option>
						@for (item of addressOptions(); track item.subDistrict) {
						<option [value]="item.subDistrict">{{ item.subDistrict }}</option>
						}
					</select>
				</div>

				<div class="form-group">
					<label>เขต/อำเภอ</label>
					<input type="text" placeholder="อำเภอ" formControlName="district" readonly>
				</div>
			</div>

			<div class="form-group">
				<label>จังหวัด</label>
				<input type="text" placeholder="จังหวัด" formControlName="province" readonly>
			</div>

			<div class="payment-section">
				<label class="payment-label">ช่องทางการชำระเงิน</label>

				<div class="payment-options">
					<label class="option-item">
						<input type="radio" value="bank_transfer" formControlName="paymentMethod">
						<div class="option-content">
							<lucide-icon name="landmark" [size]="24"></lucide-icon>
							<span>โอนเงินผ่านธนาคาร</span>
						</div>
					</label>

					<label class="option-item">
						<input type="radio" value="promptpay" formControlName="paymentMethod">
						<div class="option-content">
							<lucide-icon name="qr-code" [size]="24"></lucide-icon>
							<span>สแกนจ่าย (QR PromptPay)</span>
						</div>
					</label>

					<label class="option-item">
						<input type="radio" value="cod" formControlName="paymentMethod">
						<div class="option-content">
							<lucide-icon name="truck" [size]="24"></lucide-icon>
							<span>เก็บเงินปลายทาง (COD)</span>
						</div>
					</label>

				</div>
			</div>

			<button class="confirm-btn" [disabled]="checkoutForm.invalid" (click)="onConfirmOrder()">
				ยืนยันการสั่งซื้อ
			</button>
		</form>
	</div>
</div>
}

@if (isOrderSuccess()) {
<div class="success-overlay">
	<div class="success-card">
		<div class="success-icon">
			<lucide-icon name="circle-check" [size]="80"></lucide-icon>
		</div>
		<h2>สั่งซื้อเรียบร้อย!</h2>
		<p>ขอบคุณที่ร่วมเป็นส่วนหนึ่งของ DEVA SHOP</p>

		<div class="order-details">
			<div class="detail-row">
				<span>เลขที่คำสั่งซื้อ:</span>
				<strong>#DEVA-123456</strong>
			</div>
			<div class="detail-row">
				<span>ยอดชำระทั้งสิ้น:</span>
				<strong>{{ finalAmount() | number }} บาท</strong>
			</div>
			<div class="detail-row">
				<span>ชำระเงินผ่าน:</span>
				<strong>
					@if (selectedPaymentMethod() === 'bank_transfer') { โอนเงินผ่านธนาคาร }
					@else if (selectedPaymentMethod() === 'promptpay') { สแกนจ่าย (QR Code) }
					@else if (selectedPaymentMethod() === 'cod') { เก็บเงินปลายทาง }
				</strong>
			</div>
		</div>

		<div class="payment-details-box">
			@if (selectedPaymentMethod() === 'bank_transfer') {
			<div class="bank-info">
				<p class="bank-name">
					<lucide-icon name="landmark" [size]="20"></lucide-icon>
					ธนาคารกสิกรไทย (KBANK)
				</p>
				<p class="acc-number">012-3-45678-9</p>
				<p class="acc-name">ชื่อบัญชี: บจก. เดวา ช็อป</p>
			</div>
			}

			@if (selectedPaymentMethod() === 'promptpay') {
			<div class="qr-info">
				<p>สแกนเพื่อชำระเงิน</p>
				<qrcode [qrdata]="qrCodeString()" [width]="256" [errorCorrectionLevel]="'M'"></qrcode>
				<p class="ref-text">ยอดชำระเงิน : {{ finalAmount() | number }} บาท</p>
			</div>
			}

			@if (selectedPaymentMethod() === 'cod') {
			<div class="cod-info">
				<lucide-icon name="truck" [size]="48"></lucide-icon>
				<p>เตรียมเงินสดไว้รอรับของได้เลย!</p>
				<p class="cod-note">พนักงานจะโทรหาก่อนเข้าไปส่งสินค้า</p>
			</div>
			}
		</div>

		<button class="checkout-btn" (click)="goToHome()">ไปช้อปปิ้งต่อกันเลย</button>
	</div>
</div>
}